import{ao as b,f as R,d as Q,l as W,r as s,o as N,c as Z,i as c,w as u,a as r,j as k,B as $,q as aa,x as ta,F as ea,aq as oa,al as ia,ar as x,as as ra,H as la,bX as sa,J as na,L as ca,__tla as ua}from"./index-438cb142.js";import{_ as ma,__tla as pa}from"./Dialog.vue_vue_type_style_index_0_lang-cf80572b.js";import{_ as da,__tla as _a}from"./Form-819b02f5.js";import{b as A,__tla as fa}from"./formatTime-f3e5076d.js";import{r as m,__tla as ya}from"./formRules-23ea6cb1.js";import{D as ba,__tla as va}from"./dict-3f0c5214.js";import{u as ha,__tla as ga}from"./useCrudSchemas-6550bd84.js";import{_ as wa,__tla as Pa}from"./SpuSelect.vue_vue_type_script_setup_true_lang-6a1778bc.js";import{_ as Sa,__tla as ka}from"./SpuAndSkuList.vue_vue_type_script_setup_true_lang-fb6956cf.js";import{g as Ca,__tla as Ia}from"./index-e6011b97.js";import{i as Da,__tla as Fa}from"./spu-7e53fdff.js";import{u as Ta,__tla as Va}from"./useMessage-a65b1a59.js";let E,q,G,U,Ya=Promise.all([(()=>{try{return ua}catch{}})(),(()=>{try{return pa}catch{}})(),(()=>{try{return _a}catch{}})(),(()=>{try{return fa}catch{}})(),(()=>{try{return ya}catch{}})(),(()=>{try{return va}catch{}})(),(()=>{try{return ga}catch{}})(),(()=>{try{return Pa}catch{}})(),(()=>{try{return ka}catch{}})(),(()=>{try{return Ia}catch{}})(),(()=>{try{return Fa}catch{}})(),(()=>{try{return Va}catch{}})()]).then(async()=>{let C,I,D;U=async d=>await b.get({url:"/promotion/combination-activity/page",params:d}),q=async d=>await b.put({url:"/promotion/combination-activity/close?id="+d}),G=async d=>await b.delete({url:"/promotion/combination-activity/delete?id="+d}),C=R({name:[m],totalLimitCount:[m],singleLimitCount:[m],startTime:[m],endTime:[m],userSize:[m],limitDuration:[m],virtualGroup:[m]}),I=R([{label:"\u62FC\u56E2\u540D\u79F0",field:"name",isSearch:!0,isTable:!1,form:{colProps:{span:24}}},{label:"\u6D3B\u52A8\u5F00\u59CB\u65F6\u95F4",field:"startTime",formatter:A,isSearch:!0,search:{component:"DatePicker",componentProps:{valueFormat:"YYYY-MM-DD",type:"daterange"}},form:{component:"DatePicker",componentProps:{type:"date",valueFormat:"x"}},table:{width:120}},{label:"\u6D3B\u52A8\u7ED3\u675F\u65F6\u95F4",field:"endTime",formatter:A,isSearch:!0,search:{component:"DatePicker",componentProps:{valueFormat:"YYYY-MM-DD",type:"daterange"}},form:{component:"DatePicker",componentProps:{type:"date",valueFormat:"x"}},table:{width:120}},{label:"\u53C2\u4E0E\u4EBA\u6570",field:"userSize",isSearch:!1,form:{component:"InputNumber",labelMessage:"\u53C2\u4E0E\u4EBA\u6570\u4E0D\u80FD\u5C11\u4E8E\u4E24\u4EBA",value:2}},{label:"\u9650\u5236\u65F6\u957F",field:"limitDuration",isSearch:!1,isTable:!1,form:{component:"InputNumber",labelMessage:"\u9650\u5236\u65F6\u957F(\u5C0F\u65F6)",componentProps:{placeholder:"\u8BF7\u8F93\u5165\u9650\u5236\u65F6\u957F(\u5C0F\u65F6)"}}},{label:"\u603B\u9650\u8D2D\u6570\u91CF",field:"totalLimitCount",isSearch:!1,isTable:!1,form:{component:"InputNumber",value:0}},{label:"\u5355\u6B21\u9650\u8D2D\u6570\u91CF",field:"singleLimitCount",isSearch:!1,isTable:!1,form:{component:"InputNumber",value:0}},{label:"\u865A\u62DF\u6210\u56E2",field:"virtualGroup",dictType:ba.INFRA_BOOLEAN_STRING,dictClass:"boolean",isSearch:!0,form:{component:"Radio",value:!1}},{label:"\u62FC\u56E2\u5546\u54C1",field:"spuId",isSearch:!1,form:{colProps:{span:24}}}]),{allSchemas:D}=ha(I),E=Q({name:"PromotionCombinationActivityForm",__name:"CombinationActivityForm",emits:["success"],setup(d,{expose:j,emit:z}){const{t:P}=W(),F=Ta(),_=s(!1),T=s(""),f=s(!1),V=s(""),p=s(),Y=s(),L=s(),h=s([]),S=s([]),B=[{name:"productConfig.combinationPrice",rule:o=>o>=.01,message:"\u5546\u54C1\u62FC\u56E2\u4EF7\u683C\u4E0D\u80FD\u5C0F\u4E8E0.01 \uFF01\uFF01\uFF01"}],O=(o,a)=>{p.value.setValues({spuId:o}),M(o,a)},M=async(o,a,t)=>{var g;const l=[],n=await Da([o]);if(n.length==0)return;h.value=[];const e=n[0],y=a===void 0?e==null?void 0:e.skus:(g=e==null?void 0:e.skus)==null?void 0:g.filter(i=>a.includes(i.id));y==null||y.forEach(i=>{let v={spuId:e.id,skuId:i.id,combinationPrice:0};if(t!==void 0){const w=t.find(K=>K.skuId===i.id);w&&(w.combinationPrice=oa(w.combinationPrice)),v=w||v}i.productConfig=v}),e.skus=y,l.push({spuId:e.id,spuDetail:e,propertyList:Ca(e)}),h.value.push(e),S.value=l};j({open:async(o,a)=>{var t;if(_.value=!0,T.value=P("action."+o),V.value=o,await H(),a){f.value=!0;try{const l=await(async n=>await b.get({url:"/promotion/combination-activity/get?id="+n}))(a);await M(l.spuId,(t=l.products)==null?void 0:t.map(n=>n.skuId),l.products),p.value.setValues(l)}finally{f.value=!1}}}});const H=async()=>{h.value=[],S.value=[],await ia(),p.value.getElFormRef().resetFields()},J=z,X=async()=>{if(p&&await p.value.getElFormRef().validate()){f.value=!0;try{const o=x(L.value.getSkuConfigs("productConfig"));o.forEach(t=>{t.combinationPrice=ra(t.combinationPrice)});const a=x(p.value.formModel);a.products=o,V.value==="create"?(await(async t=>await b.post({url:"/promotion/combination-activity/create",data:t}))(a),F.success(P("common.createSuccess"))):(await(async t=>await b.put({url:"/promotion/combination-activity/update",data:t}))(a),F.success(P("common.updateSuccess"))),_.value=!1,J("success")}finally{f.value=!1}}};return(o,a)=>{const t=la,l=sa,n=na,e=da,y=ma,g=ca;return N(),Z(ea,null,[c(y,{modelValue:r(_),"onUpdate:modelValue":a[2]||(a[2]=i=>ta(_)?_.value=i:null),title:r(T),width:"65%"},{footer:u(()=>[c(t,{disabled:r(f),type:"primary",onClick:X},{default:u(()=>[k("\u786E \u5B9A")]),_:1},8,["disabled"]),c(t,{onClick:a[1]||(a[1]=i=>_.value=!1)},{default:u(()=>[k("\u53D6 \u6D88")]),_:1})]),default:u(()=>[$((N(),aa(e,{ref_key:"formRef",ref:p,"is-col":!0,rules:r(C),schema:r(D).formSchema,class:"mt-10px"},{spuId:u(()=>[c(t,{onClick:a[0]||(a[0]=i=>r(Y).open())},{default:u(()=>[k("\u9009\u62E9\u5546\u54C1")]),_:1}),c(r(Sa),{ref_key:"spuAndSkuListRef",ref:L,"rule-config":B,"spu-list":r(h),"spu-property-list-p":r(S)},{default:u(()=>[c(n,{align:"center",label:"\u62FC\u56E2\u4EF7\u683C(\u5143)","min-width":"168"},{default:u(({row:i})=>[c(l,{modelValue:i.productConfig.combinationPrice,"onUpdate:modelValue":v=>i.productConfig.combinationPrice=v,min:0,precision:2,step:.1,class:"w-100%"},null,8,["modelValue","onUpdate:modelValue"])]),_:1})]),_:1},8,["spu-list","spu-property-list-p"])]),_:1},8,["rules","schema"])),[[g,r(f)]])]),_:1},8,["modelValue","title"]),c(r(wa),{ref_key:"spuSelectRef",ref:Y,isSelectSku:!0,onConfirm:O},null,512)],64)}}})});export{E as _,Ya as __tla,q as c,G as d,U as g};
